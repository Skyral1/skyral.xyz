name: Deploy to Apache Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted # <--- Important : utilise TON serveur

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false # Évite de tout supprimer avant le pull

      - name: Sync files to Web Root
        run: |
          # -a : archive mode
          # -v : verbose
          # --delete : supprime les fichiers qui ne sont plus dans le repo
          # -I : ignore-times (force la copie même si la taille/date semble identique)
          # --chmod=Du=rwx,Dg=rwx,Do=rx,Fu=rw,Fg=rw,Fo=r : force les bonnes permissions
          rsync -avI --delete --exclude '.git' --exclude '.github' --chmod=Du=rwx,Dg=rwx,Do=rx,Fu=rw,Fg=rw,Fo=r ./ /var/www/html/

      - name: Fix Permissions
        run: |
          # S'assurer que Apache peut toujours lire les fichiers
          chown -R deploy:www-data /var/www/html
          chmod -R 775 /var/www/html
